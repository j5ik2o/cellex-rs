# 内部テストモジュール分割作業手順

本作業は `modules/actor-core/src` 配下のプロダクションコードからテストコードを切り出し、`tests.rs` サブモジュールへ整理することを目的とします。

## 1. 対象ファイルの選定
- プロダクションコードファイルとテストが同居している箇所をすべて対象とする。
- すでにテスト専用ファイル（`*_tests.rs` など）に分離済みの場合は対象外とする。

## 2. テストモジュールの分離手順
1. 対象ファイル `<module>.rs` と同じディレクトリに `tests.rs` を新規作成する。
2. `<module>.rs` に以下があることを確認。なければ追加する。
   ```rust
   #[cfg(test)]
   mod tests;
   ```
3. 既存テストコード（すべての `#[test]` ブロック）を `tests.rs` へ移動する。
4. `tests.rs` 冒頭で `use super::*;` を追加し、テスト対象モジュールのシンボルを利用できるようにする。
5. テスト専用で必要な `use` 文やフィクスチャを `tests.rs` 内に再配置する。

## 3. 条件付きコンパイルの整理
- プロダクションコードからテスト関連のコードをすべて除去し、同等の処理を `tests.rs` 内へ移す。
- テスト内での条件付きコンパイルは基本的に `#[cfg(test)]` へ統一する。

## 4. ビルド・テストの実行
1. `makers fmt` を実行して整形を行う。
2. `cargo test --workspace` を実行し、すべてのテストが成功することを確認する。
3. 必要に応じて `cargo check -p cellex-actor-core-rs --no-default-features --features alloc` で no_std ビルドも確認する。

## 5. 残作業の確認
- `rg "#[cfg(feature = \"std\"]" modules/actor-core/src -g'!**/tests.rs'` を実行し、プロダクションコードに `std` 依存の条件付きビルドが残っていないか確認する。
- `git status` で変更ファイルを確認する。

## 6. 報告
- 作業完了後、`cargo test --workspace` の結果と主要変更点をまとめて報告する。
- `AGENTS.md` で定義されたルール（STD 分岐をプロダクションコードに残さない等）を遵守したことを明記する。
