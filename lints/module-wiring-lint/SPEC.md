# module-wiring-lint 仕様

## 目的

- Rust モジュールの結線規約において「末端モジュールの一つ上の親モジュール以外での再エクスポート禁止」を機械的に検査し、誤用を早期に検知する。
- 既存ガイドラインに沿った `mod` と公開制御の記述パターンを強制し、意図しない API 提供や循環依存を防ぐ。

## 原則ルール

- 末端モジュール以外のモジュールで: `mod child;` / `pub mod child;` / `pub(crate) mod child;` は許可する
-  `use`に一切制限はない
- すべてのファイルで: `pub use ...;` と `pub(crate) use ...;` は原則として禁止する

## 末端モジュール判定

- 「末端モジュール」とは、ファイル／ディレクトリ上に更なる `mod` 宣言やサブモジュールが存在しないモジュールを指す
- 判定時は `mod child;` / `pub mod child;` / `pub(crate) mod child;` を解析し、対応するファイル／ディレクトリを遡って再帰的に探索する

## 再エクスポート許可の例外

1. **末端モジュールの一つ上の親モジュール**
   - 当該親モジュール内に `mod child;` と `pub use child::Type;` (`pub(crate) use` を含む) が同居しており、`child` が末端モジュールである場合のみ再エクスポートを許可する
   - 許可されるのは `child` で宣言されたシンボルに対する単純なパスであり、`pub use child::Type;` や `pub use child::{TypeA, TypeB};`、`pub use child::*;` といった同一末端モジュール内の一括公開パターンを許容する
   - ただし `as` 句によるリネームは引き続き禁止とする
3. **prelude モジュール**
   - `prelude` というモジュール (ファイル `prelude.rs` または `lib.rs` 内の `mod prelude` 等) では再エクスポートを許可する。
   - 同一クレート内に複数の `prelude` モジュールがある場合、モジュールパスが `...::prelude` で終わるものすべてを例外扱いする。

## 無効化コメント
- 行コメント `// allow module_wiring::no_parent_reexport` (プレフィックスや lint ID は仮) を対象行もしくは直前に付与した場合、その行に限り違反を無視する。
- ブロックコメントでの `allow` は未対応。必要であれば追加仕様で検討する。

## 診断メッセージ指針
- 違反を検出した場合、以下の情報を含めた `error` を報告する。
  - 再エクスポートを記述したファイルと行番号。
  - 該当シンボルが末端モジュールかどうかの判定結果、および末端でなかった場合の理由。
  - 許可される書き換え方 (例: `mod child;` のみを残す、もしくは末端モジュールまで移動させる) の簡潔な提案。
  - どの仕様ルール (例: 「原則ルール: 再エクスポート禁止」「例外ルール: 末端モジュールの直属親のみ許可」) に違反したかを明示する識別子または文言。
- 例外条件に該当する場合は診断を発生させない。

## 今後の実装タスク (メモ)
- `syn` や `rust-analyzer` クレートの解析結果を利用してモジュール構造を走査するロジックを実装する。
- 端末モジュール探索のためにファイルシステムと AST の両方を突き合わせる。
- 既存リント (`tests-location-lint`) と同様に `ui` テストを整備し、例外ケース (main / prelude / allow コメント) を網羅する。
